/*!
 * author: FDD <smileFDD@gmail.com> 
 * wind-layer v0.0.5
 * build-time: 2018-8-10 21:34
 * LICENSE: MIT
 * (c) 2017-2018 https://sakitam-fdd.github.io/wind-layer
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.windLayer=e()}(this,function(){"use strict";var o=function(l){l.projection||(l.projection="EPSG:4326");var f,y,h,g,v,w,m,p,u,E,c=l.minVelocity||0,d=l.maxVelocity||10,o=(l.velocityScale||.005)*(Math.pow(window.devicePixelRatio,1/3)||1),M=l.particleAge||90,x=l.lineWidth||1,_=l.particleMultiplier||1/300,b=Math.pow(window.devicePixelRatio,1/3)||1.6,C=1e3/(l.frameRate||15),P=l.colorScale||["rgb(36,104, 180)","rgb(60,157, 194)","rgb(128,205,193 )","rgb(151,218,168 )","rgb(198,231,181)","rgb(238,247,217)","rgb(255,238,159)","rgb(252,217,125)","rgb(255,182,100)","rgb(252,150,75)","rgb(250,112,52)","rgb(245,64,32)","rgb(237,45,28)","rgb(220,24,32)","rgb(180,0,35)"],r=[NaN,NaN,null],s=l.data,W=function(t,e,n,i,a,o){var r=1-t,s=1-e,h=r*s,p=t*s,u=r*e,c=t*e,d=n[0]*h+i[0]*p+a[0]*u+o[0]*c,l=n[1]*h+i[1]*p+a[1]*u+o[1]*c;return[d,l,Math.sqrt(d*d+l*l)]},z=function(t){var e,n,i,a,o=null,r=null;return t.forEach(function(t){switch(t.header.parameterCategory+","+t.header.parameterNumber){case"1,2":case"2,2":o=t;break;case"1,3":case"2,3":r=t}}),n=r,i=(e=o).data,a=n.data,{header:e.header,data:function(t){return[i[t],a[t]]},interpolate:W}},D=function(t,e){if(!y)return null;var n,i=I(t-g,360)/w,a=(v-e)/m,o=Math.floor(i),r=o+1,s=Math.floor(a),h=s+1;if(n=y[s]){var p=n[o],u=n[r];if(S(p)&&S(u)&&(n=y[h])){var c=n[o],d=n[r];if(S(c)&&S(d))return f.interpolate(i-o,a-s,p,u,c,d)}}return null},S=function(t){return null!=t},I=function(t,e){return t-e*Math.floor(t/e)},j=function(t,e,n,i,a,o){var r=2*Math.PI,s="EPSG:4326"===l.projection?5:Math.pow(10,-5.2),h=e<0?s:-s,p=n<0?s:-s,u=L(n,e+h,o),c=L(n+p,e,o),d=Math.cos(n/360*r);return[(u[0]-i)/h/d,(u[1]-a)/h/d,(c[0]-i)/p,(c[1]-a)/p]},F=function(i,a,t){function o(t,e){var n=i[Math.round(t)];return n&&n[Math.round(e)]||r}o.release=function(){i=[]},o.randomize=function(t){for(var e,n,i=0;null===o(e=Math.round(Math.floor(Math.random()*a.width)+a.x),n=Math.round(Math.floor(Math.random()*a.height)+a.y))[2]&&i++<30;);return t.x=e,t.y=n,t},t(a,o)},N=function(t){return t/180*Math.PI},T=function(t){return t/(Math.PI/180)};E="EPSG:4326"===l.projection?function(t,e,n){var i=n.east-n.west,a=n.south-n.north,o=T(n.north)+e/n.height*T(a);return[T(n.west)+t/n.width*T(i),o]}:function(t,e,n){var i=n.east-n.west,a=n.width/T(i)*360/(2*Math.PI),o=a/2*Math.log((1+Math.sin(n.south))/(1-Math.sin(n.south))),r=(n.height+o-e)/a,s=180/Math.PI*(2*Math.atan(Math.exp(r))-Math.PI/2);return[T(n.west)+t/n.width*T(i),s]};var A,B=function(t){return Math.log(Math.tan(t/2+Math.PI/4))},L=function(t,e,n){var i=B(n.south),a=B(n.north),o=n.width/(n.east-n.west),r=n.height/(a-i),s=B(N(t));return[(N(e)-n.west)*o,s=(a-s)*r]},O=function(i,s){var e,n,h=(e=c,n=d,P.indexFor=function(t){return Math.max(0,Math.min(P.length-1,Math.round((t-e)/(n-e)*(P.length-1))))},P),p=h.map(function(){return[]}),t=Math.round(i.width*i.height*_);/android|blackberry|iemobile|ipad|iphone|ipod|opera mini|webos/i.test(navigator.userAgent)&&(t*=b);for(var a=[],o=0;o<t;o++)a.push(s.randomize({age:Math.floor(Math.random()*M)+0}));var r=l.canvas.getContext("2d");r.lineWidth=x,r.fillStyle="rgba(0, 0, 0, 0.97)",r.globalAlpha=.6;var u=Date.now();!function t(){A=requestAnimationFrame(t);var e=Date.now(),n=e-u;C<n&&(u=e-n%C,p.forEach(function(t){t.length=0}),a.forEach(function(t){t.age>M&&(s.randomize(t).age=0);var e=t.x,n=t.y,i=s(e,n),a=i[2];if(null===a)t.age=M;else{var o=e+i[0],r=n+i[1];null!==s(o,r)[2]?(t.xt=o,t.yt=r,p[h.indexFor(a)].push(t)):(t.x=o,t.y=r)}t.age+=1}),r.globalCompositeOperation="destination-in",r.fillRect(i.x,i.y,i.width,i.height),r.globalCompositeOperation="lighter",r.globalAlpha=.9,p.forEach(function(t,e){0<t.length&&(r.beginPath(),r.strokeStyle=h[e],t.forEach(function(t){r.moveTo(t.x,t.y),r.lineTo(t.xt,t.yt),t.x=t.xt,t.y=t.yt}),r.stroke())}))}()},R=function(e,n,i,t){var a={south:N(t[0][1]),north:N(t[1][1]),east:N(t[1][0]),west:N(t[0][0]),width:n,height:i};$(),function(t,e){var n=(f=z(t)).header;g=n.lo1,v=n.la1,w=n.dx,m=n.dy,p=n.nx,u=n.ny,(h=new Date(n.refTime)).setHours(h.getHours()+n.forecastTime),y=[];for(var i=0,a=360<=Math.floor(p*w),o=0;o<u;o++){for(var r=[],s=0;s<p;s++,i++)r[s]=f.data(i);a&&r.push(r[0]),y[o]=r}e({date:h,interpolate:D})}(s,function(t){!function(w,m,M,n){var x={},t=(M.south-M.north)*(M.west-M.east),_=o*Math.pow(t,.4),b=[],i=m.x;function a(t){for(var e,n,i,a,o,r,s,h,p,u,c,d=[],l=m.y;l<=m.yMax;l+=2){var f=E(t,l,M);if(f){var y=f[0],g=f[1];if(isFinite(y)){var v=w.interpolate(y,g);v&&(e=x,n=y,i=g,a=t,o=l,r=_,h=M,p=(s=v)[0]*r,u=s[1]*r,c=j(e,n,i,a,o,h),s[0]=c[0]*p+c[2]*u,s[1]=c[1]*p+c[3]*u,v=s,d[l+1]=d[l]=v)}}}b[t+1]=b[t]=d}!function t(){for(var e=Date.now();i<m.width;)if(a(i),i+=2,1e3<Date.now()-e)return void setTimeout(t,25);F(b,m,n)}()}(t,function(t,e,n){var i=t[0],a=t[1],o=Math.round(i[0]),r=Math.max(Math.floor(i[1],0),0);Math.min(Math.ceil(a[0],e),e-1);return{x:o,y:r,xMax:e,yMax:Math.min(Math.ceil(a[1],n),n-1),width:e,height:n}}(e,n,i),a,function(t,e){q.field=e,O(t,e)})})},$=function(){q.field&&q.field.release(),A&&cancelAnimationFrame(A)},q={params:l,start:R,stop:$,update:function(t,e,n,i,a){delete l.data,l.data=t,a&&R(e,n,i,a)},shift:function(t,e){var n=l.canvas,i=n.width,a=n.height,o=n.getContext("2d");if(t<i&&e<a){var r=function(t,e){return Math.max(0,Math.min(t,e))},s=o.getImageData(r(i,-t),r(a,-e),r(i,i-t),r(a,a-e));o.clearRect(0,0,i,a),o.putImageData(s,r(i,t),r(a,e));for(var h=0,p=particles.length;h<p;h++)particles[h].x+=t,particles[h].y+=e}},createField:F,interpolatePoint:D,setData:function(t){s=t}};return q};window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){return window.setTimeout(t,1e3/FRAME_RATE)},window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)});var r=function(t,e,n){if("undefined"!=typeof document){var i=document.createElement("canvas");return i.width=t,i.height=e,i}return new n(t,e)},s=function(t,e,n){n.endsWith("CCW")&&(e=0<e?e=-e:Math.abs(e));var i=Math.sqrt(Math.pow(t,2)+Math.pow(e,2)),a=180*Math.atan2(t/i,e/i)/Math.PI+180;return"bearingCW"!==n&&"meteoCCW"!==n||360<=(a+=180)&&(a-=360),a},h=function(t,e,n){var i=Math.sqrt(Math.pow(t,2)+Math.pow(e,2));return"k/h"===n?p(i):"kt"===n?a(i):i},a=function(t){return t/.514},p=function(t){return 3.6*t},u=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},t=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},c=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},d=("undefined"==typeof window?{}:window).ol||{};d.layer||(d.layer={}),d.layer.Image||(d.layer.Image=function t(){u(this,t)});var e=function(i){function a(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};u(this,a);var n=c(this,i.call(this,e));return n._canvas=null,n.data=t,n.$Windy=null,n.isClear=!1,n.options=e,n.setSource(new d.source.ImageCanvas({logo:e.logo,state:e.state,attributions:e.attributions,resolutions:e.resolutions,canvasFunction:n.canvasFunction.bind(n),projection:e.hasOwnProperty("projection")?e.projection:"EPSG:3857",ratio:e.hasOwnProperty("ratio")?e.ratio:1})),n.on("precompose",n.redraw,n),n}return t(a,i),a.prototype.getData=function(){return this.data},a.prototype.setData=function(t){var e=this.getMap();if(!e)return this;if(this.data=t,this.isClear=!1,!this.$Windy&&this._canvas)this.render(this._canvas),e.renderSync();else if(this.$Windy&&this._canvas){this._cloneLayer&&(e.addLayer(this._cloneLayer),delete this._cloneLayer);var n=this._getExtent();this.$Windy.update(this.getData(),n[0],n[1],n[2],n[3])}else console.warn("please create new instance");return this},a.prototype.render=function(t){var e=this._getExtent();if(this.isClear||!this.getData()||!e)return this;if(t&&!this.$Windy)this.$Windy=new o({canvas:t,projection:this.get("projection"),data:this.getData()}),this.$Windy.start(e[0],e[1],e[2],e[3]);else if(t&&this.$Windy){var n=this._getExtent();this.$Windy.start(n[0],n[1],n[2],n[3])}return this},a.prototype.redraw=function(){if(!this.isClear){var t=this.options.extent||this._getMapExtent();this.setExtent(t)}},a.prototype.canvasFunction=function(t,e,n,i,a){return this._canvas?(this._canvas.width=i[0],this._canvas.height=i[1]):this._canvas=r(i[0],i[1]),e<=this.get("maxResolution")&&this.render(this._canvas),this._canvas},a.prototype._getExtent=function(){var t=this._getMapSize(),e=this._getMapExtent();if(t&&e){var n=this.get("projection"),i=d.proj.transformExtent(e,n,"EPSG:4326");return[[[0,0],[t[0],t[1]]],t[0],t[1],[[i[0],i[1]],[i[2],i[3]]]]}return!1},a.prototype._getMapExtent=function(){if(this.getMap()){var t=this._getMapSize(),e=this.getMap().getView();return e&&e.calculateExtent(t)}},a.prototype._getMapSize=function(){if(this.getMap())return this.getMap().getSize()},a.prototype.appendTo=function(t){if(!(t&&t instanceof d.Map))throw new Error("not map object");this.set("originMap",t),t.addLayer(this)},a.prototype.getPointData=function(t){var e=this.$Windy.interpolatePoint(t[0],t[1]);if(e&&!isNaN(e[0])&&!isNaN(e[1])&&e[2])return{direction:s(e[0],e[1],this.options.angleConvention||"bearingCCW"),speed:h(e[0],e[1],this.options.speedUnit)}},a.prototype.clearWind=function(){var t=this.getMap();t&&(this.$Windy&&this.$Windy.stop(),this.isClear=!0,this._cloneLayer=this,t.removeLayer(this),this.changed(),this.getMap().renderSync())},a.prototype.removeLayer=function(){var t=this.getMap();t&&(this.$Windy&&this.$Windy.stop(),this.un("precompose",this.redraw,this),t.removeLayer(this),delete this._canvas,delete this.$Windy,delete this._cloneLayer)},a.prototype.setMap=function(t){this.set("originMap",t)},a.prototype.getMap=function(){return this.get("originMap")},a}(d.layer.Image),i=("undefined"==typeof window?{}:window).AMap||{},n=function(){function n(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};u(this,n),this.options=e,this.canvas=null,this.data=t,this.layer_=null,this._windy=null,e.map&&this.appendTo(e.map)}return n.prototype.appendTo=function(t){var e=this;if(!t)throw new Error("not map object");t.on("complete",function(){e.init(t)},this)},n.prototype.getData=function(){return this.data},n.prototype.setData=function(t){this.data=t,this.map&&this.canvas&&this.data&&this.render()},n.prototype.init=function(t,e){if(!t)throw new Error("not map object");this.map=t,this.context=this.options.context||"2d",this.getCanvasLayer()},n.prototype.render=function(t){if(t){var e=this._getExtent();return this.getData()&&e&&(t&&!this._windy?(this._windy=new o({canvas:t,data:this.getData(),onDraw:function(){}}),this._windy.start(e[0],e[1],e[2],e[3])):t&&this._windy&&this._windy.start(e[0],e[1],e[2],e[3])),this}},n.prototype.getCanvasLayer=function(){if(!this.canvas&&!this.layer_){var t=this.canvasFunction(),e=this.map.getBounds();this.layer_=new i.CanvasLayer({canvas:t,bounds:this.options.bounds||e,zooms:this.options.zooms||[0,22]}),this.map.on("mapmove",this.canvasFunction,this),this.map.on("zoomchange",this.canvasFunction,this),this.layer_.setMap(this.map)}},n.prototype.canvasFunction=function(){var t=[this.map.getSize().width,this.map.getSize().height],e=t[0],n=t[1];if(this.canvas){this.canvas.width=e,this.canvas.height=n;var i=this.map.getBounds();this.layer_&&this.layer_.setBounds(this.options.bounds||i)}else this.canvas=r(e,n,null);return this.render(this.canvas),this.canvas},n.prototype._getExtent=function(){var t=[this.map.getSize().width,this.map.getSize().height],e=t[0],n=t[1],i=this.map.getBounds().getNorthEast(),a=this.map.getBounds().getSouthWest();return[[[0,0],[e,n]],e,n,[[i.lng,i.lat],[a.lng,a.lat]]]},n.prototype.removeLayer=function(){this.map&&(this.map.removeLayer(this.layer_),delete this.map,delete this.layer_,delete this.canvas)},n.prototype.getContext=function(){return this.canvas.getContext(this.context)},n.prototype.getPointData=function(t){var e=this._windy.interpolatePoint(t[0],t[1]);if(e&&!isNaN(e[0])&&!isNaN(e[1])&&e[2])return{direction:s(e[0],e[1],this.options.angleConvention||"bearingCCW"),speed:h(e[0],e[1],this.options.speedUnit)}},n.prototype.clearWind=function(){this._windy&&this._windy.stop()},n}(),l="undefined"==typeof window?{}:window;return l.BMap||(l.BMap={}),l.BMap.Overlay||(l.BMap.Overlay=function t(){u(this,t)}),{AMapWind:n,BMapWind:function(i){function a(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};u(this,a);var n=c(this,i.call(this,e));return n.options=e,n.paneName=n.options.paneName||"mapPane",n.context=n.options.context||"2d",n.zIndex=n.options.zIndex||0,n.mixBlendMode=n.options.mixBlendMode||null,n.enableMassClear=n.options.enableMassClear,n._map=e.map,n._lastDrawTime=null,n.canvas=null,n.data=t,n._windy=null,n.show(),n}return t(a,i),a.prototype.getData=function(){return this.data},a.prototype.setData=function(t){this.data=t,this._map&&this.data&&this._draw()},a.prototype._getExtent=function(){var t=this._map.getSize(),e=this._map.getBounds().getNorthEast(),n=this._map.getBounds().getSouthWest();return[[[0,0],[t.width,t.height]],t.width,t.height,[[e.lng,e.lat],[n.lng,n.lat]]]},a.prototype.appendTo=function(t){if(!t)throw new Error("not map object");t.addOverlay(this)},a.prototype.initialize=function(t){var e=this;this._map=t;var n=this.canvas=document.createElement("canvas");return n.style.cssText="position:absolute; left:0; top:0; z-index: "+this.zIndex+" ;user-select:none;",n.style.mixBlendMode=this.mixBlendMode,this.adjustSize(),t.getPanes()[this.paneName].appendChild(n),t.addEventListener("resize",function(){e.adjustSize(),e._draw()}),this.canvas},a.prototype.adjustSize=function(){var t=this._map.getSize(),e=this.canvas,n=this.devicePixelRatio=l.devicePixelRatio||1;e.width=t.width*n,e.height=t.height*n,"2d"===this.context&&e.getContext(this.context).scale(n,n),e.style.width=t.width+"px",e.style.height=t.height+"px"},a.prototype.draw=function(){var t=this;clearTimeout(t.timeoutID),t.timeoutID=setTimeout(function(){t._draw()},15)},a.prototype._draw=function(){var t=this._map,e=t.getSize(),n=t.getCenter();if(n){var i=t.pointToOverlayPixel(n);this.canvas.style.left=i.x-e.width/2+"px",this.canvas.style.top=i.y-e.height/2+"px",this.dispatchEvent("draw"),this.options.update&&this.options.update.call(this),this.render(this.canvas)}},a.prototype.render=function(t){var e=this._getExtent();return this.getData()&&e&&(t&&!this._windy?(this._windy=new o({canvas:t,data:this.getData(),onDraw:function(){}}),this._windy.start(e[0],e[1],e[2],e[3])):t&&this._windy&&this._windy.start(e[0],e[1],e[2],e[3])),this},a.prototype.getContainer=function(){return this.canvas},a.prototype.setZIndex=function(t){this.zIndex=t,this.canvas.style.zIndex=this.zIndex},a.prototype.getZIndex=function(){return this.zIndex},a.prototype.getPointData=function(t){var e=this._windy.interpolatePoint(t[0],t[1]);if(e&&!isNaN(e[0])&&!isNaN(e[1])&&e[2])return{direction:s(e[0],e[1],this.options.angleConvention||"bearingCCW"),speed:h(e[0],e[1],this.options.speedUnit)}},a.prototype.clearWind=function(){this._windy&&this._windy.stop()},a}(l.BMap.Overlay),OlWind:e}});